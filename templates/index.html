<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>URL Shortener</title>

<!-- QRCode.js for QR generation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
  body {
    font-family: Arial, sans-serif;
    background: #f4f7fc;
    min-height: 100vh;
    margin: 0;
    padding: 40px 20px;
    display: flex;
    justify-content: center;
  }
  .card {
    background: #fff;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    max-width: 600px;
    width: 100%;
    text-align: center;
  }
  h1 { color: #333; }
  input {
    width: 70%;
    padding: 12px;
    font-size: 16px;
    border-radius: 6px;
    border: 1px solid #ccc;
  }
  button {
    padding: 12px 20px;
    font-size: 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }
  .shorten-btn { background: #4CAF50; color: white; margin-left: 10px; }
  .copy-btn { background: #007BFF; color: white; margin-top: 10px; }
  .result-box {
    background: #eef3ff;
    padding: 20px;
    border-radius: 8px;
    margin-top: 20px;
  }
  table {
    margin: 20px auto;
    border-collapse: collapse;
    width: 100%;
  }
  th, td {
    border: 1px solid #ddd;
    padding: 10px;
  }
  th { background: #f4f4f4; }
  a { color: #007BFF; text-decoration: none; }
  a:hover { text-decoration: underline; }
</style>
</head>
<body>

<div class="card">
  <h1>ðŸ”— URL Shortener</h1>

  <input type="text" id="originalUrl" placeholder="Enter your long URL"/>
  <button class="shorten-btn" onclick="shortenUrl()">Shorten</button>

  <div id="result" class="result-box" style="display:none;"></div>

  <div id="historySection" style="margin-top: 30px; display:none;">
    <h2>ðŸ“œ History</h2>
    <table>
      <thead>
        <tr>
          <th>Original URL</th>
          <th>Short URL</th>
        </tr>
      </thead>
      <tbody id="historyTable"></tbody>
    </table>
  </div>
</div>

<script>
  const backendUrl = "http://127.0.0.1:5000"; // Flask API

  // Fetch history from Flask database
  async function loadHistory() {
    try {
      const res = await fetch(`${backendUrl}/history`);
      const historyList = await res.json();

      const tableBody = document.getElementById("historyTable");
      tableBody.innerHTML = "";

      if (historyList.length > 0) {
        document.getElementById("historySection").style.display = "block";
        historyList.forEach(item => {
          const row = `<tr>
            <td>${item.original_url || item.original}</td>
            <td><a href="${item.short_url || item.short}" target="_blank">${item.short_url || item.short}</a></td>
          </tr>`;
          tableBody.innerHTML += row;
        });
      } else {
        document.getElementById("historySection").style.display = "none";
      }
    } catch (err) {
      console.error("Failed to load history:", err);
    }
  }

  async function shortenUrl() {
    const originalUrl = document.getElementById("originalUrl").value.trim();
    if (!originalUrl) return alert("Please enter a URL");

    try {
      const response = await fetch(`${backendUrl}/shorten`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ original_url: originalUrl })
      });
      const data = await response.json();
      if (data.short_url) {
        showResult(originalUrl, data.short_url);
        document.getElementById("originalUrl").value = "";
        await loadHistory(); // refresh history from database
      }
    } catch (err) {
      console.error("Error:", err);
    }
  }

  function showResult(originalUrl, shortUrl) {
    const resultDiv = document.getElementById("result");
    resultDiv.style.display = "block";
    resultDiv.innerHTML = `
      <p><strong>Short URL:</strong> <a href="${shortUrl}" target="_blank">${shortUrl}</a></p>
      <button class="copy-btn" onclick="copyToClipboard('${shortUrl}')">ðŸ“‹ Copy</button>
      <div id="qrcode"></div>
    `;
    new QRCode(document.getElementById("qrcode"), {
      text: shortUrl,
      width: 150,
      height: 150
    });
  }

  function copyToClipboard(text) {
    navigator.clipboard.writeText(text);
    alert("Short URL copied to clipboard!");
  }

  // Initialize
  loadHistory();
</script>
</body>
</html>
